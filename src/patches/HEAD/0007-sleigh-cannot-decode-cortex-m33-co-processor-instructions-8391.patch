From c31780358b6e0f95891a73db15a1cf35e562ebe0 Mon Sep 17 00:00:00 2001
From: Andrew Fernandes <andrew@fernandes.org>
Date: Thu, 21 Aug 2025 15:59:30 -0700
Subject: [PATCH] Remove the CDE instructions in favour of the RP2350
 Co-Processor instructions

---
 .../Processors/ARM/data/languages/ARM.ldefs   | 62 +++++++++++++++----
 .../ARM/data/languages/ARM8m_cp_be.slaspec    | 19 ++++++
 .../ARM/data/languages/ARM8m_cp_le.slaspec    | 19 ++++++
 3 files changed, 87 insertions(+), 13 deletions(-)
 create mode 100644 Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
 create mode 100644 Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec

diff --git a/Ghidra/Processors/ARM/data/languages/ARM.ldefs b/Ghidra/Processors/ARM/data/languages/ARM.ldefs
index e914419a8d..b8bc4e5c16 100644
--- a/Ghidra/Processors/ARM/data/languages/ARM.ldefs
+++ b/Ghidra/Processors/ARM/data/languages/ARM.ldefs
@@ -24,7 +24,7 @@
     <external_name tool="qemu" name="qemu-arm"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
   <language processor="ARM"
             endian="little"
             size="32"
@@ -37,7 +37,7 @@
     <description>Generic ARM/Thumb v8 little endian (Thumb is default)</description>
     <compiler name="default" spec="ARM.cspec" id="default"/>
     <compiler name="Visual Studio" spec="ARM_win.cspec" id="windows"/>
-    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>    
+    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
     <external_name tool="gnu" name="iwmmxt"/>
     <external_name tool="gnu" name="arm_any"/>
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
@@ -46,7 +46,7 @@
     <external_name tool="qemu" name="qemu-arm"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
   <language processor="ARM"
             endian="big"
             instructionEndian="little"
@@ -63,7 +63,7 @@
     <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
-  
+
   <language processor="ARM"
             endian="big"
             size="32"
@@ -86,7 +86,7 @@
     <external_name tool="qemu" name="qemu-armeb"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
   <language processor="ARM"
             endian="big"
             size="32"
@@ -106,7 +106,7 @@
     <external_name tool="qemu" name="qemu-armeb"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
   <language processor="ARM"
             endian="little"
             size="32"
@@ -145,7 +145,7 @@
     <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
-  
+
   <language processor="ARM"
             endian="big"
             size="32"
@@ -213,7 +213,7 @@
     <external_name tool="qemu" name="qemu-armeb"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
   <language processor="ARM"
             endian="little"
             size="32"
@@ -232,6 +232,24 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
+  <language processor="ARM"
+            endian="little"
+            size="32"
+            variant="v8-m"
+            version="1.107"
+            slafile="ARM8m_cp_le.sla"
+            processorspec="ARMCortex.pspec"
+            manualindexfile="../manuals/ARM.idx"
+            id="ARM:LE:32:v8-m-cp">
+    <description>ARM Cortex v8-m little endian</description>
+    <compiler name="default" spec="ARM.cspec" id="default"/>
+    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
+    <external_name tool="gnu" name="armv8-m.base"/>
+    <external_name tool="gnu" name="armv8-m.main"/>
+    <external_name tool="gnu" name="armv8.1-m.main"/>
+    <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
+    <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
+  </language>
   <language processor="ARM"
             endian="big"
             size="32"
@@ -250,7 +268,25 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
   </language>
-  
+  <language processor="ARM"
+            endian="big"
+            size="32"
+            variant="v8-m"
+            version="1.107"
+            slafile="ARM8m_cp_be.sla"
+            processorspec="ARMCortex.pspec"
+            manualindexfile="../manuals/ARM.idx"
+            id="ARM:BE:32:v8-m-cp">
+    <description>ARM Cortex v8-m big endian</description>
+    <compiler name="default" spec="ARM.cspec" id="default"/>
+    <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
+    <external_name tool="gnu" name="armv8-m.base"/>
+    <external_name tool="gnu" name="armv8-m.main"/>
+    <external_name tool="gnu" name="armv8.1-m.main"/>
+    <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
+    <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/>
+  </language>
+
   <language processor="ARM"
             endian="little"
             size="32"
@@ -268,7 +304,7 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="IDA-PRO" name="arm"/>
     <external_name tool="DWARF.register.mapping.file" name="ARM.dwarf"/>
-    <!-- change DWARF register mapping to ARMneon.dwarf if VFPv2 is enabled --> 
+    <!-- change DWARF register mapping to ARMneon.dwarf if VFPv2 is enabled -->
     <!-- <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/> -->
     <external_name tool="qemu" name="qemu-arm"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
@@ -291,7 +327,7 @@
     <external_name tool="gdis.disassembler.options.file" name="ARM.gdis"/>
     <external_name tool="IDA-PRO" name="armb"/>
     <external_name tool="DWARF.register.mapping.file" name="ARM.dwarf"/>
-    <!-- change DWARF register mapping to ARMneon.dwarf if VFPv2 is enabled --> 
+    <!-- change DWARF register mapping to ARMneon.dwarf if VFPv2 is enabled -->
     <!-- <external_name tool="DWARF.register.mapping.file" name="ARMneon.dwarf"/> -->
     <external_name tool="qemu" name="qemu-armeb"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
@@ -385,7 +421,7 @@
             slafile="ARM4t_le.sla"
             processorspec="ARMt_v45.pspec"
             manualindexfile="../manuals/ARM.idx"
-            id="ARM:LE:32:v4t"> 
+            id="ARM:LE:32:v4t">
     <description>Generic ARM/Thumb v4 little endian (T-variant)</description>
     <compiler name="default" spec="ARM_v45.cspec" id="default"/>
     <compiler name="APCS" spec="ARM_apcs.cspec" id="apcs"/>
@@ -462,5 +498,5 @@
     <external_name tool="qemu" name="qemu-armeb"/>
     <external_name tool="qemu_system" name="qemu-system-arm"/>
   </language>
-  
+
 </language_definitions>
diff --git a/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
new file mode 100644
index 0000000000..9c5d055611
--- /dev/null
+++ b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_be.slaspec
@@ -0,0 +1,19 @@
+
+@define ENDIAN "big"
+@define T_VARIANT ""
+@define VERSION_5 ""
+@define VERSION_5E ""
+@define VERSION_6 ""
+@define VERSION_6K ""
+@define VERSION_6T2 ""
+@define VERSION_7 ""
+@define VERSION_7M ""
+@define VERSION_8 ""
+@define SIMD ""
+# https://github.com/NationalSecurityAgency/ghidra/issues/8391
+@define CORTEX ""
+@define VFPv3 ""
+@define VFPv4 ""
+
+@include "ARM.sinc"
+@include "ARM_CDE.sinc"
diff --git a/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec
new file mode 100644
index 0000000000..181c80b1a1
--- /dev/null
+++ b/Ghidra/Processors/ARM/data/languages/ARM8m_cp_le.slaspec
@@ -0,0 +1,19 @@
+
+@define ENDIAN "little"
+@define T_VARIANT ""
+@define VERSION_5 ""
+@define VERSION_5E ""
+@define VERSION_6 ""
+@define VERSION_6K ""
+@define VERSION_6T2 ""
+@define VERSION_7 ""
+@define VERSION_7M ""
+@define VERSION_8 ""
+@define SIMD ""
+# https://github.com/NationalSecurityAgency/ghidra/issues/8391
+@define CORTEX ""
+@define VFPv3 ""
+@define VFPv4 ""
+
+@include "ARM.sinc"
+@include "ARM_CDE.sinc"
-- 
2.51.0

